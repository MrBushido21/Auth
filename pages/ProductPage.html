<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Товар</title>
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    background: #f5f5f5;
  }

  .container {
    background: white;
    padding: 20px;
    border-radius: 10px;
    max-width: 800px;
    margin: auto;
    display: flex;
    gap: 20px;
    align-items: flex-start;
  }

  .image-box {
    width: 250px;
    height: 180px;
    border-radius: 10px;
    background: #cde6ff;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }

  .image-box img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .info {
    display: flex;
    flex-direction: column;
    row-gap: 5px;
  }

  .title {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 8px;
  }

  .availability {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 12px;
    color: white;
    font-size: 14px;
    margin-bottom: 8px;
  }

  .yes { background: #4caf50; }
  .no { background: #999; }

  .rating { margin: 5px 0; }
  .stars { color: #ff9800; font-size: 16px; }

  .code {
    font-size: 14px;
    color: #555;
    margin-top: 5px;
  }

  .price {
    margin-top: 12px;
    font-size: 22px;
    font-weight: bold;
    color: #e53935;
  }
</style>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-09KKBSN12N"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-09KKBSN12N');
</script>
<body>

<div class="container">
  <div class="image-box" id="productImage"></div>
  <div class="info">
  <div class="title" id="title">Загрузка...</div>

  <div id="availability"></div>

  <a href="/otzyvy" style="text-decoration: none; color: inherit;" class="rating stars" id="ratingBlock"></a>

  <div class="code" id="productCode"></div>

  <div class="price" id="price"></div>

  <!-- Кнопка добавить в корзину -->
  <button id="addToCartBtn" style="
    margin-top: 15px;
    padding: 12px;
    background: #2c7be5;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    cursor: pointer;
  ">
    Добавить в корзину
  </button>
</div>

</div>


<script>
// --- helper: звёзды ---
function getStars(rating) {
  let full = Math.round(rating);
  let stars = "";
  for (let i = 0; i < 5; i++) stars += i < full ? "★" : "☆";
  return stars;
}

// Добавление в корзину
function addToCart(productId, quantity) {
  quantity = Number(quantity) || 0;
  if (quantity <= 0) {
    alert("Товара нет в наличии!");
    return;
  }

  let cart = JSON.parse(localStorage.getItem("cart") || "[]");
  const existing = cart.find(item => item.productId === productId);

  if (existing) {
    if (existing.qty + 1 > existing.products_qty) {
      alert("Столько товара нет в наличии!");
      return;
    }
    existing.qty += 1;
  } else {
    cart.push({ productId, qty: 1, products_qty: quantity });
  }

  localStorage.setItem("cart", JSON.stringify(cart));
  alert("Товар добавлен в корзину!");
}

async function loadProduct() {
  try {
    const params = new URLSearchParams(location.search);
    const id = params.get('id');
    let res = await fetch(`/getproduct?id=${id}`);
    if (!res.ok) throw new Error();
    return await res.json();
  } catch (e) {
    return null; // если товара нет
  }
}

(async () => {
  const p = await loadProduct();

  if (!p) {
    document.querySelector(".container").innerHTML = '<h2 style="color:red;">Товар отсутствует</h2>';
    return;
  }

  // фото
  const imgBox = document.getElementById("productImage");
  if (p.image_url) imgBox.innerHTML = `<img src="${p.image_url}" alt="Фото">`;
  else imgBox.textContent = "Фото нет";

  // название
  document.getElementById("title").textContent = p.title;

  // наличие
  const avail = document.getElementById("availability");
  if (p.quantity > 0) {
    avail.className = "availability yes";
    avail.textContent = "В наличии";
  } else {
    avail.className = "availability no";
    avail.textContent = "Нет в наличии";
  }

  // рейтинг
  const ratingBlock = document.getElementById("ratingBlock");
  ratingBlock.href = `/otzyvy?id=${p.id}`;
  ratingBlock.innerHTML = `${getStars(p.rating)} ${p.rating.toFixed(1)} • ${p.qntrewies} отзывов`;

  // код товара
  document.getElementById("productCode").textContent = "Код товара: " + p.id;

  // цена
  document.getElementById("price").textContent = p.price.toLocaleString("ru-RU") + " ₴";

  // кнопка корзины
  const btn = document.getElementById("addToCartBtn");
  btn.onclick = () => addToCart(p.id, p.quantity);

  // если товара нет, сделать кнопку неактивной
  if (p.quantity <= 0) {
    btn.disabled = true;
    btn.textContent = "Нет в наличии";
    btn.style.background = "#999";
    btn.style.cursor = "not-allowed";
  }
})();

</script>


</body>
</html>
