<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤</title>
  <style>
    body {
      font-family: Arial;
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
      background: #f0f0f0;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
    }

    /* ===== –®–∞–ø–∫–∞ —Å –ø—Ä–æ—Ñ–∏–ª–µ–º ===== */
    .header {
      position: relative;
    }

    .user-link {
      position: absolute;
      top: 0;
      right: 0;
      padding: 8px 14px;
      background: white;
      border-radius: 8px;
      text-decoration: none;
      color: #2c7be5;
      font-weight: bold;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      transition: background 0.2s;
    }

    .cart-link {
      position: absolute;
      top: 0;
      left: 0;
      padding: 8px 14px;
      background: white;
      border-radius: 8px;
      text-decoration: none;
      color: #2c7be5;
      font-weight: bold;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      transition: background 0.2s;
    }
    .wish-link {
      position: absolute;
      top: 0px;
      left: 130px;
      padding: 8px 14px;
      background: white;
      border-radius: 8px;
      text-decoration: none;
      color: #2c7be5;
      font-weight: bold;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      transition: background 0.2s;
    }

    .user-link:hover {
      background: #f2f6ff;
    }


    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–∏—Å–∫–∞ + —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ */
    #controls {
      display: flex;
      gap: 20px;
      margin-bottom: 25px;
      justify-content: center;
    }

    #controls input,
    #controls select {
      padding: 10px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    #products {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
    }

    .product-card {
      padding: 15px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .product-card h3 {
      margin: 0 0 10px;
    }

    .price {
      font-weight: bold;
      margin: 10px 0;
    }

    .card-link {
      text-decoration: none;
      color: inherit
    }

    button {
      margin-top: auto;
      padding: 10px;
      background: #2c7be5;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 15px;
      border-radius: 6px;
    }

    button:hover {
      background: #1a5fc4;
    }
  </style>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-09KKBSN12N"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-09KKBSN12N');
</script>
<body>
  <div class="header">
    <h1>–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤</h1>
    <a href="/user" class="user-link">üë§ –ö–∞–±–∏–Ω–µ—Ç</a>
    <a href="/cart" class="cart-link">
      –ö–æ—Ä–∑–∏–Ω–∞ <span id="cart-count"
        style="background:red; color:white; border-radius:50%; padding:2px 6px; font-size:12px; margin-left:5px;">0</span>
    </a>
  <a href="/wishlist" class="wish-link">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</a>
  </div>

  <!-- =========================================================== -->

  <!-- ========–ü–†–û–ë–õ–ï–ú–ê –° –ö–ù–û–ü–ö–û–ô –ó–ê–ì–†–£–ó–ò–¢–¨ –ï–©–ï================== -->

  <!-- =========================================================== -->
  <!-- ========= –ü–æ–∏—Å–∫ + —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ ========= -->
  <div id="controls">
  <input type="text" id="search" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤..." oninput="loadProducts()" />

  <select id="category" onchange="loadProducts()">
    <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
  </select>

 <select id="filter" onchange="loadProducts()">
  <option value="price">–¶–µ–Ω–∞</option>
  <option value="rating">–†–µ–π—Ç–∏–Ω–≥</option>
  <option value="created">–ù–æ–≤–∏–∑–Ω–∞</option>
</select>
<button id="toggleSort" onclick="toggleSort()">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å: –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</button>


  <label>
    <input type="checkbox" id="filter-in-stock" onchange="fetchProducts()" /> –í –Ω–∞–ª–∏—á–∏–∏
  </label>
  <label>
    <input type="checkbox" id="filter-sale" onchange="fetchProducts()" /> –°–∫–∏–¥–∫–∞
  </label>
</div>


  <div id="products">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  <button id="loadMore" onclick="loadMore()" style="display: none; margin: 20px auto; display: block;">–∑–∞—É–≥—Ä—É–∑–∏—Ç—å
    –µ—â–µ</button>
  <script>
    // ====== –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ======
    let currentPage = 0; // –ö–∞–∫–∞—è —Å–µ–π—á–∞—Å —Å—Ç—Ä–∞–Ω–∏—Ü–∞
    const limit = 5; // –°–∫–æ–ª—å–∫–æ –≥—Ä—É–∑–∏–º –∑–∞ —Ä–∞–∑
    let isLoading = false; // –ß—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏–ª–∏ –∫–ª–∏–∫–∞–º–∏
    let categoriesLoaded = false;
    const token = localStorage.getItem("accessToken");
    // localStorage.clear();

    function updateCartCount() {
      const cart = JSON.parse(localStorage.getItem("cart") || "[]");
      const totalQty = cart.length
      document.getElementById("cart-count").textContent = totalQty;
    }

    // –í—ã–∑—ã–≤–∞—Ç—å –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É
    function addToCart(productId, products_qty) {
      products_qty = Number(products_qty) || 0;

      let cart = JSON.parse(localStorage.getItem("cart") || "[]");
      const existing = cart.find(item => item.productId === productId);

      if (existing) {
        if (existing.qty + 1 > existing.products_qty) {
          alert("–°—Ç–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä–∞ –Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏!");
          return;
        }
        existing.qty += 1;
      } else {
        if (products_qty <= 0) {
          alert("–¢–æ–≤–∞—Ä–∞ –Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏!");
          return;
        }
        cart.push({ productId, qty: 1, products_qty });
      }

      localStorage.setItem("cart", JSON.stringify(cart));
      updateCartCount();
      alert("–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É!");
    }

    function addToWish(productId) {
      fetch("/createwishlist", {
        method: "POST",
        headers: { "Content-Type": "application/json", "authorization": `Bearer ${token}` },
        body: JSON.stringify({ product_id: productId })
      })
        .then(r => r.json())
        .then(() => alert("–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ!"))
        .catch(err => alert("–û—à–∏–±–∫–∞: " + err));
    }



    // ===== –†–µ–Ω–¥–µ—Ä –∫–∞—Ä—Ç–æ—á–µ–∫ =====
    function renderProducts(items) {
      const container = document.getElementById("products");

      if (items.length === 0 && currentPage === 0) {
        container.innerHTML = '<p>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
        document.getElementById("loadMore").style.display = "none";
        return;
      }

      items.forEach(item => {
        const card = document.createElement("div");
        card.className = "product-card";

        // –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä–∞ –Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏
        const outOfStock = item.quantity === 0; // –∏–ª–∏ item.stock === 0
        if (outOfStock) {
          card.style.opacity = "0.5";
        }

        card.innerHTML = `
      <a href="/product?id=${item.id}" class="card-link">
        <img src="${item.image_url}" alt="." style="width:100%; border-radius:8px; margin-bottom:10px;">
        <h3>${item.title}</h3>
      </a>
      <p>${item.description}</p>
      ${item.sale ? `<p class="price">–°–∫–∏–¥–∫–∞ ${item.sale * 100}%</p>` : ""}
      <p class="price">${item.price} –≥—Ä–Ω</p>
      ${outOfStock ?
            `<p style="color:red; font-weight:bold;">–¢–æ–≤–∞—Ä–∞ –Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</p>` :
            `<button onclick='addToCart(${item.id}, ${JSON.stringify(item.quantity)})'>–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button>`
          }
      <button style="margin: 10px 0;" onclick="addToWish(${item.id})">–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
    `;
        container.appendChild(card);
      });

      // –ö–Ω–æ–ø–∫–∞ "–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â–µ"
      if (items.length === limit) {
        document.getElementById("loadMore").style.display = "block";
      } else {
        document.getElementById("loadMore").style.display = "none";
      }
    }
let currentSort = "desc"; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

function toggleSort() {
  const btn = document.getElementById("toggleSort");
  if (currentSort === "asc") {
    currentSort = "desc";
    btn.textContent = "–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å: –ø–æ —É–±—ã–≤–∞–Ω–∏—é";
  } else {
    currentSort = "asc";
    btn.textContent = "–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å: –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é";
  }
  loadProducts(); // –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
}

    // ===== –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ =====
   function fetchProducts() {
  if (isLoading) return;
  isLoading = true;

  const search = document.getElementById("search").value;
  const categoryId = document.getElementById("category").value;
  const filter = document.getElementById("filter").value; // price | rating | created
  const inStock = document.getElementById("filter-in-stock").checked;
  const sale = document.getElementById("filter-sale").checked;

  // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ñ–∏–ª—å—Ç—Ä –ø–æ –Ω–æ–≤–∏–∑–Ω–µ, —Å–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ–≥–¥–∞ –ø–æ —É–±—ã–≤–∞–Ω–∏—é
  let sortValue = currentSort;

  const params = new URLSearchParams();
  if (search) params.append("search", search);
  if (categoryId) params.append("category_id", categoryId);
  if (filter) params.append("filter", filter);
  if (inStock) params.append("in_stock", "1");
  if (sale) params.append("sale", "1");

  params.append("sort", sortValue); // –ø–µ—Ä–µ–¥–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ asc/desc
  params.append("page", currentPage);
  params.append("limit", limit);

  fetch(`/getproducts_data?${params.toString()}`)
    .then(res => res.json())
    .then(items => {
      const container = document.getElementById("products");

      if (!categoriesLoaded && items.length > 0) {
        const select = document.getElementById("category");
        const map = new Map();
        items.forEach(item => map.set(item.category_id, item.category));
        map.forEach((name, id) => {
          const option = document.createElement("option");
          option.value = id;
          option.textContent = name;
          select.appendChild(option);
        });
        categoriesLoaded = true;
      }

      if (currentPage === 0) {
        container.innerHTML = "";
      }

      renderProducts(items);
      isLoading = false;
    })
    .catch(err => {
      document.getElementById("products").innerHTML = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: " + err;
      isLoading = false;
    });
}

    // ===== –ü–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–ª–∏ –ø–æ–∏—Å–∫ ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É =====
    function loadProducts() {
      currentPage = 0;
      fetchProducts();
    }

    // ===== –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã =====
    function loadMore() {
      currentPage++;
      fetchProducts();
    }
    // ===== –°—Ç–∞—Ä—Ç =====
    window.onload = () => {
  loadProducts();
  updateCartCount();
};
  </script>


</body>

</html>