<!Doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Смена пароля</title>
  <style>
    :root{font-family:Inter, Roboto, Arial, sans-serif}
    body{display:flex;align-items:center;justify-content:center;min-height:100vh;background:#f3f4f6;margin:0}
    .card{background:#fff;padding:28px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.08);width:100%;max-width:420px}
    h1{font-size:20px;margin:0 0 12px}
    p.help{color:#6b7280;margin:0 0 18px;font-size:13px}
    label{display:block;font-size:13px;margin-bottom:6px}
    input[type=password]{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:8px;font-size:14px}
    .row{margin-bottom:12px}
    button{width:100%;padding:11px;border:0;border-radius:10px;background:#111827;color:#fff;font-weight:600;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .meta{font-size:13px;color:#374151;margin-top:10px}
    .error{color:#b91c1c}
    .success{color:#065f46}
    .small{font-size:12px;color:#6b7280}
  </style>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-09KKBSN12N"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-09KKBSN12N');
</script>
<body>
  <main class="card" role="main">
    <h1>Сброс пароля</h1>
    <p class="help">Откройте эту страницу по ссылке, полученной в письме. Параметры <code>token</code> и <code>key</code> берутся из URL.</p>

    <div id="notice" class="meta small"></div>

    <form id="form">
      <div class="row">
        <label for="password">Новый пароль</label>
        <input id="password" name="password" type="password" autocomplete="new-password" required minlength="6" />
      </div>

      <div class="row">
        <label for="password2">Повторите пароль</label>
        <input id="password2" name="password2" type="password" autocomplete="new-password" required minlength="6" />
      </div>

      <button id="submit">Сменить пароль</button>
    </form>

    <div id="result" class="meta" aria-live="polite"></div>
  </main>

  <script>
    (function(){
      const params = new URLSearchParams(location.search);
      const token = params.get('token');
      const key = params.get('key');
      const type = params.get('type');
      const notice = document.getElementById('notice');
      const form = document.getElementById('form');
      const submit = document.getElementById('submit');
      const result = document.getElementById('result');

      if(!token || !key){
        notice.innerHTML = '<span class="error">Ошибка: в URL отсутствует token или key. Проверьте ссылку из письма.</span>';
        submit.disabled = true;
        return;
      }

      notice.textContent = 'Токен и ключ успешно найдены в ссылке.';

      function showMessage(text, kind){
        result.textContent = text;
        result.className = kind === 'ok' ? 'meta success' : 'meta error';
      }

      form.addEventListener('submit', async function(e){
        e.preventDefault();
        showMessage('', '');

        const p1 = document.getElementById('password').value.trim();
        const p2 = document.getElementById('password2').value.trim();

        if(p1.length < 6){ showMessage('Пароль должен быть не короче 6 символов.','err'); return; }
        if(p1 !== p2){ showMessage('Пароли не совпадают.','err'); return; }

        submit.disabled = true;
        submit.textContent = 'Отправка...';

        try{
          const payload = { token: token, key: key, newvalue: p1, type: type};

          const resp = await fetch('/changepasswordoremail', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          const text = await resp.text().catch(()=>null);
          let data = null;
          try{ data = text ? JSON.parse(text) : null } catch(err){ /* ответ не json */ }

          if(resp.ok){
             showMessage(
            (data && data.message) ? data.message : 'Пароль успешно изменён. Перенаправление...',
            'ok'
          );
          form.reset();
            // сохранить access_token в localStorage
          if (data && data.access_token) {
            console.log(data.access_token);
            
            localStorage.setItem('accessToken', data.access_token);
          }
          // переадресация на /getproducts через 1.5 сек
          setTimeout(() => {
            window.location.href = '/getproducts';
          }, 1500);
          } else {
            const msg = (data && data.error) ? data.error : (data && data.message) ? data.message : (text || ('Ошибка: ' + resp.status));
            showMessage(msg, 'err');
          }
        } catch(err){
          showMessage('Сетевая ошибка: ' + err.message, 'err');
        } finally{
          submit.disabled = false;
          submit.textContent = 'Сменить пароль';
        }
      });

    })();
  </script>
</body>
</html>
