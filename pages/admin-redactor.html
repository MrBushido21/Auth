<!DOCTYPE html><html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Список товаров</title>
  <style>
  body { font-family: Arial; max-width: 1200px; margin: 40px auto; padding: 20px; background: #f0f0f0; }
    h1 { text-align: center; margin-bottom: 30px; }
    #products {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
    }
    .product-card {
      padding: 15px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    /* Контейнер поиска + сортировки */
    #controls {
      display: flex;
      gap: 20px;
      margin-bottom: 25px;
      justify-content: center;
    }
    #controls input, #controls select {
      padding: 10px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    input, textarea {
      width: 100%;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    button {
      margin-top: auto;
      padding: 10px;
      background: #2c7be5;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 15px;
      border-radius: 6px;
    }
    button:hover { background: #1a5fc4; }
    label { font-weight: bold; font-size: 14px; }


  </style>
</head>
<body>
    <h1>Редактирование товаров</h1>

  <!-- ========= Поиск + сортировка ========= -->
  <div id="controls">
    <input 
      type="text" 
      id="search" 
      placeholder="Поиск товаров..." 
      oninput="loadProducts()"
    />
  </div>

  <div id="products">Загрузка...</div> 
  <script>
    function addToCart(productId) {
      fetch("/cart/add", {
        method: "POST",
        headers: { "Content-Type": "application/json", 
        "authorization": ""
       },
        body: JSON.stringify({ product_id: productId, quantity: 1})
        
      })
      .then(r => r.json())
      .then(response => {
        alert("Товар добавлен в корзину!");
        console.log(response);
      })
      .catch(err => alert("Ошибка: " + err));
    }

    function createProductCard(item) {
      const card = document.createElement('div');
      card.className = 'product-card';

      card.innerHTML = `
        <p>ID товару: ${item.id}</p>
        <label>Название:</label>
        <input type="text" value="${item.title}" id="title-${item.id}" />

        <label>Описание:</label>
        <textarea id="desc-${item.id}">${item.description}</textarea>

        <label>Цена (грн):</label>
        <input type="number" step="0.01" value="${item.price}" id="price-${item.id}" />

        <label>Количество на складе:</label>
        <input type="number" step="0.01" value="${item.quantity}" id="quantity-${item.id}" />

        <label>Добавить скидку в %:</label>
        <input type="number" step="0.01" value="${item.sale * 100}" id="sale-${item.id}" />

        <button onclick="editProduct(${item.id})">Редактировать товар</button>
        <button onclick="deleteProduct(${item.id})">Удалить товар</button>
      `;
      return card;
    }

    function renderProducts(data) {
      const container = document.getElementById('products');
      container.innerHTML = '';

      data.forEach(item => {
        container.appendChild(createProductCard(item));
      });
    }

    async function editProduct(id) {
      const title = document.getElementById(`title-${id}`).value;
      const description = document.getElementById(`desc-${id}`).value;
      const price = parseFloat(document.getElementById(`price-${id}`).value);
      const quantity = parseFloat(document.getElementById(`quantity-${id}`).value);
      const sale = parseFloat(document.getElementById(`sale-${id}`).value);

      try {
        const res = await fetch(`/admin/edit-product?id=${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, description, price, quantity, sale })
        });

        if (!res.ok) throw new Error('Ошибка при обновлении товара');
        alert('Товар успешно обновлен!');
      } catch(err) {
        alert(err.message);
      }
    }
    async function deleteProduct(id) {

      try {
        const res = await fetch(`/admin/delete-product?id=${id}`, {
          method: 'DELETE',
          headers: { "authorization": ""}
        });

        if (!res.ok) throw new Error('Ошибка при удалении товара');
        alert('Товар успешно удален!');
      } catch(err) {
        alert(err.message);
      }
    }


        // ======== Основная функция загрузки ========
      function loadProducts() {
      const search = document.getElementById("search").value;
      
      fetch(`/getproducts_data?search=${encodeURIComponent(search)}&sort=asc`, {
        method: "GET",
        headers: { "Content-Type": "application/json", 
        "authorization": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6ImFkbWluIiwiaWQiOjIwNDIsImlhdCI6MTc2NDMxNzY5NiwiZXhwIjoxNzY0MzIxMjk2fQ.Nwhu4d5QPip4Mj8dONy62ECShw0OOLRQaD3yfQIE3aw"
       }
      })
        .then(res => res.json())
        .then(response => renderProducts(response))
        .catch(err => {
          document.getElementById('products').innerText = 'Ошибка загрузки данных: ' + err;
        });
    }

    // При загрузке страницы
    loadProducts();
  </script>
  </body>
</html>
