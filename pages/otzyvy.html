<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Товар — Відгуки</title>
  <style>
    :root{--green:#2f8f4a;--muted:#f3f4f5;--radius:12px}
    *{box-sizing:border-box}
    body{font-family:Inter, Arial, sans-serif;margin:0;background:#fff;color:#222}
    .container{max-width:720px;margin:0 auto;padding:14px}

    /* Product header */
    .product{display:flex;gap:12px;align-items:flex-start}
    .thumb{width:120px;height:120px;border-radius:12px;background:#e3f2ff;flex:0 0 120px;display:flex;align-items:center;justify-content:center;color:#0b66b2}
    .thumb img{width:100%;height:100%;object-fit:cover;border-radius:12px}
    .meta{flex:1}
    .title{font-weight:700;font-size:18px;margin-bottom:6px}
    .price{color:#e53935;font-weight:700;margin-top:8px}

    /* rating summary */
    .rating-row{display:flex;align-items:center;gap:10px;margin:12px 0}
    .avg{font-size:20px;font-weight:700}
    .small{color:#666;font-size:13px}

    /* controls */
    .btn{display:inline-block;padding:12px 16px;border-radius:10px;background:var(--green);color:#fff;text-decoration:none;cursor:pointer;border:0}
    .write-btn{width:100%;background:#fff;border:1px solid #ddd;color:var(--green);font-weight:600}

    /* Reviews list */
    .reviews{margin-top:14px}
    .review{border:1px solid #eee;border-radius:12px;padding:12px;margin-bottom:10px;background:#fff}
    .review .name{font-weight:700}
    .stars{color:orange;font-weight:700}

    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.4);display:none;align-items:flex-end}
    .modal{background:#fff;border-radius:14px 14px 0 0;padding:16px;width:100%;max-width:720px}
    .modal h3{margin:0 0 8px;font-size:18px}
    .stars-input{display:flex;gap:8px;margin-bottom:12px}
    .star{font-size:24px;opacity:.35;cursor:pointer}
    .star.active{opacity:1;color:orange}
    .field{margin-bottom:12px}
    input[type=text],textarea{width:100%;padding:12px;border-radius:10px;border:1px solid #e6e6e6;font-size:14px}
    textarea{min-height:110px;resize:vertical}
    .modal-actions{display:flex;gap:8px}

    /* small helpers */
    .row{display:flex;gap:8px;align-items:center}
    .badge{background:var(--muted);padding:6px 10px;border-radius:999px;font-size:13px}

    /* responsive */
    @media(min-width:660px){.container{padding:20px}.thumb{width:140px;height:140px}}
  </style>
</head>
<body>
  <div class="container">
    <div class="product">
      <div class="thumb" id="thumb">
        <!-- if image provided, replace with <img> -->
        <span>Фото</span>
      </div>
      <div class="meta">
        <div class="title" id="title">Назва товару приклад</div>
        <div class="small">Категорія · Код товару 12345</div>
        <div class="rating-row">
          <div class="avg" id="avg">4.07<span style="font-size:14px;color:#666">/5</span></div>
          <div class="small">на основі <strong id="count">31</strong> відгук(ів)</div>
        </div>
        <div style="margin-top:8px">
          <button class="btn write-btn" id="openReview">Написати відгук</button>
        </div>
        <div class="price">30 999 ₴</div>
      </div>
    </div>

    <div class="reviews" id="reviews">
      <!-- example review -->
      <div class="review">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="name">Сергій Гутян</div>
            <div class="stars">★★★★★</div>
          </div>
          <div class="small">вчора</div>
        </div>
        <div style="margin-top:8px;font-weight:600">За свої кошти топ</div>
        <div class="small" style="margin-top:6px">Переваги: Легенький,швидкий...</div>
      </div>
    </div>
  </div>

  <!-- modal -->
  <div class="modal-backdrop" id="backdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3>Написати відгук</h3>
        <button id="close" style="background:none;border:0;font-size:20px;cursor:pointer">✕</button>
      </div>

      <div class="small">Оцініть товар</div>
      <div class="stars-input" id="starInput">
        <span class="star" data-value="1">★</span>
        <span class="star" data-value="2">★</span>
        <span class="star" data-value="3">★</span>
        <span class="star" data-value="4">★</span>
        <span class="star" data-value="5">★</span>
      </div>

      <div class="field">
        <label class="small">Переваги</label>
        <input type="text" id="pros" placeholder="Коротко">
      </div>
      <div class="field">
        <label class="small">Недоліки</label>
        <input type="text" id="cons" placeholder="Коротко">
      </div>
      <div class="field">
        <label class="small">Коментар</label>
        <textarea id="comment" placeholder="Поділіться враженнями"></textarea>
      </div>

      <div style="border:1px solid #eee;border-radius:10px;padding:10px;margin-bottom:12px">
        <div style="font-weight:600;margin-bottom:6px">Додайте відео</div>
        <div class="small">Додавайте до 5 відео з Youtube</div>
        <input type="text" id="youtube" placeholder="Посилання на відео з Youtube">
      </div>

      <div class="modal-actions">
        <button class="btn" id="submit">Відправити відгук</button>
        <button class="write-btn" id="cancel">Відмінити</button>
      </div>
    </div>
  </div>

  <script>
  // -------------------- ПОЛУЧАЕМ product_id ИЗ URL --------------------
  const url = new URL(window.location.href);
  const productId = url.searchParams.get("id");

  // -------------------- ELEMENTS --------------------
  const backdrop = document.getElementById('backdrop')
  const openBtn = document.getElementById('openReview')
  const closeBtn = document.getElementById('close')
  const cancelBtn = document.getElementById('cancel')
  const submitBtn = document.getElementById('submit')
  const stars = document.querySelectorAll('.star')
  const reviewsBox = document.getElementById("reviews")
  let rating = 0

  // -------------------- ОТКРЫТИЕ / ЗАКРЫТИЕ МОДАЛКИ --------------------
  openBtn.addEventListener('click', ()=>{backdrop.style.display='flex'})
  closeBtn.addEventListener('click', ()=>backdrop.style.display='none')
  cancelBtn.addEventListener('click', ()=>backdrop.style.display='none')
  backdrop.addEventListener('click',(e)=>{if(e.target===backdrop)backdrop.style.display='none'})

  // -------------------- РЕЙТИНГ --------------------
  stars.forEach(s=>{
    s.addEventListener('mouseenter', ()=>highlight(+s.dataset.value))
    s.addEventListener('mouseleave', ()=>highlight(rating))
    s.addEventListener('click', ()=>{ rating = +s.dataset.value; highlight(rating) })
  })
  function highlight(v){
    stars.forEach(s=>s.classList.toggle('active', +s.dataset.value <= v))
  }

  // -------------------- 1) ПОЛУЧЕНИЕ СПИСКА ОТЗЫВОВ --------------------
  async function loadReviews(){
    try {
      const res = await fetch(`/getrewies?id=${productId}`);

      if(!res.ok){
        // backend пока отдаёт 404 → просто не показываем ничего
        reviewsBox.innerHTML = "<div class='small'>Немає відгуків</div>";
        return;
      }

      const data = await res.json();

      if(data.length === 0){
        reviewsBox.innerHTML = "<div class='small'>Немає відгуків</div>";
        return;
      }

      reviewsBox.innerHTML = "";

      data.forEach(r => {
        const div = document.createElement("div");
        div.className = "review";
        div.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div>
              <div class="name">${escapeHtml(r.user_name || "Анонім")}</div>
              <div class="stars">${"★".repeat(r.rating)}${"☆".repeat(5 - r.rating)}</div>
            </div>
            <div class="small">${escapeHtml(r.created_at || "")}</div>
          </div>

          ${r.comment ? `<div style="margin-top:8px;font-weight:600">${escapeHtml(r.comment)}</div>` : ""}
          ${r.advanage ? `<div class="small" style="margin-top:6px">Переваги: ${escapeHtml(r.advanage)}</div>` : ""}
          ${r.flaws ? `<div class="small" style="margin-top:6px">Недоліки: ${escapeHtml(r.flaws)}</div>` : ""}
        `;
        reviewsBox.appendChild(div);
      });

    } catch(e){
      console.log("Помилка:", e);
    }
  }

  loadReviews(); // ← запускаем при загрузке страницы

  // -------------------- 2) ОТПРАВКА ОТЗЫВА --------------------
  submitBtn.addEventListener('click', async ()=>{

    const pros = document.getElementById('pros').value.trim()
    const cons = document.getElementById('cons').value.trim()
    const comment = document.getElementById('comment').value.trim()

    if(rating === 0){
      alert("Будь ласка, оцініть товар.");
      return;
    }

    // токен должен быть у тебя в localStorage или где-то ещё
    const token = localStorage.getItem("token")

    try {
      const res = await fetch("/createrewies", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": token || ""
        },
        body: JSON.stringify({
          product_id: productId,
          advanage: pros,
          flaws: cons,
          comment: comment,
          rating: rating
        })
      });

      if(!res.ok){
        alert("Помилка при надсиланні відгуку.");
        return;
      }

      // отзыв успешно создан → перезагружаем список
      await loadReviews();

      // закрываем и очищаем
      backdrop.style.display = "none";
      document.getElementById('pros').value='';
      document.getElementById('cons').value='';
      document.getElementById('comment').value='';
      rating = 0;
      highlight(0);

    } catch(e){
      console.log(e);
      alert("Помилка запиту.");
    }
  });

  // -------------------- SAFE HTML --------------------
  function escapeHtml(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
  </script>
</body>
</html>
