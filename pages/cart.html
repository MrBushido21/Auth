<!DOCTYPE html> 
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ö–æ—Ä–∑–∏–Ω–∞</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #f7f7f7; }
    h1 { text-align: center; }

    .cart-item {
      background: white;
      padding: 15px;
      margin-bottom: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .cart-item img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 8px;
    }

    .cart-item-info {
      flex: 1;
    }

    .cart-item p { margin: 4px 0; }

    .qty-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 10px 0;
    }

    .qty-btn {
      padding: 6px 12px;
      font-size: 18px;
      background: #ddd;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .btn {
      padding: 8px 12px;
      margin-top: 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .btn-delete { background: #ff4d4d; color: white; }
    .btn-order {
      margin-top: 20px;
    }
    .btn-order a {
      text-decoration: none;
      background: #ff4d4d; 
      color: white; 
      border-radius: 4px;
      padding: 10px;
    }
    .btn-clear { background: #333; color: white; width: 100%; }

  </style>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-09KKBSN12N"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-09KKBSN12N');
</script>
<body>

<h1>–ö–æ—Ä–∑–∏–Ω–∞</h1>

<button class="btn btn-clear" onclick="clearCart()">–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É –ø–æ–ª–Ω–æ—Å—Ç—å—é</button>

<div id="cart-container"></div>
<span id="total"></span>
<div class="btn-order">
  <a id="orderLink" href="/order">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</a>
</div>

<script>
/* ===============================
   1. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º
================================ */
async function syncCart() {
  const cart = JSON.parse(localStorage.getItem("cart") || "[]");

  const res = await fetch('/getcartitems', {
    method: "POST",
    credentials: "include",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify(cart)
  });

  const data = await res.json();

  renderCart(data.cartItems);

  document.getElementById("total").innerText =
    `–û–±—â–∞—è —Å—É–º–º–∞: ${data.totalPrice} –≥—Ä–Ω`;

  const orderLink = document.getElementById("orderLink");

  // üî¥ –ï–°–õ–ò –ö–û–†–ó–ò–ù–ê –ü–£–°–¢–ê
  if (data.totalPrice === 0) {
    orderLink.href = "/getproducts";
    orderLink.textContent = "–ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ç–æ–≤–∞—Ä–æ–≤";
  } else {
    // üü¢ –µ—Å–ª–∏ —Ç–æ–≤–∞—Ä—ã –µ—Å—Ç—å ‚Äî –æ–±—ã—á–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
    orderLink.href = "/order";
    orderLink.textContent = "–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑";
  }
}


/* ===============================
   2. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã
================================ */
function renderCart(items) {
  const container = document.getElementById("cart-container");
  container.innerHTML = "";

  if (!items || items.length === 0) {
    container.innerHTML = "<p>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>";
    return;
  }

  items.forEach(item => {
    const div = document.createElement("div");
    div.className = "cart-item";

    div.innerHTML = `
      <img src="${item.product_img}" alt="${item.product_name}">
      <div class="cart-item-info">
        <p><strong>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞:</strong> ${item.product_name}</p>
        <p><strong>–¶–µ–Ω–∞:</strong> ${item.price} –≥—Ä–Ω</p>

        <div class="qty-controls">
          <button class="qty-btn" onclick="decreaseQty(${item.product_id})">-</button>
          <span><strong>${item.quantity}</strong></span>
          <button class="qty-btn" onclick="increaseQty(${item.product_id})">+</button>
        </div>

        <button class="btn btn-delete" onclick="deleteItem(${item.product_id})">
          –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä
        </button>
      </div>
    `;

    container.appendChild(div);
  });
}

/* ===============================
   3. –ö–Ω–æ–ø–∫–∞ +
================================ */
function increaseQty(productId) {
  let cart = JSON.parse(localStorage.getItem("cart") || "[]");
  const item = cart.find(i => i.productId === productId);

  if (!item) return;

  if (item.qty + 1 > item.products_qty) {
    alert("–°—Ç–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä–∞ –Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏!");
    return;
  }

  item.qty += 1;
  localStorage.setItem("cart", JSON.stringify(cart));
  syncCart();
}



/* ===============================
   4. –ö–Ω–æ–ø–∫–∞ -
================================ */
function decreaseQty(productId) {
  let cart = JSON.parse(localStorage.getItem("cart") || "[]");

  const index = cart.findIndex(i => i.productId === productId);
  if (index === -1) return;

  cart[index].qty -= 1;

  if (cart[index].qty <= 0) {
    cart.splice(index, 1);
  }

  localStorage.setItem("cart", JSON.stringify(cart));
  syncCart();
}

/* ===============================
   5. –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä
================================ */
function deleteItem(productId) {
  if (!confirm("–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?")) return;

  let cart = JSON.parse(localStorage.getItem("cart") || "[]");
  cart = cart.filter(i => i.productId !== productId);

  localStorage.setItem("cart", JSON.stringify(cart));
  syncCart();
}

/* ===============================
   6. –û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É
================================ */
function clearCart() {
  if (!confirm("–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É –ø–æ–ª–Ω–æ—Å—Ç—å—é?")) return;

  localStorage.removeItem("cart");
  syncCart();
}

/* ===============================
   7. –ü–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
================================ */
syncCart();
</script>


</body>
</html>
