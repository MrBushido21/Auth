<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Заказ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #f7f7f7;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
        }

        .row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #eee;
        }

        .row:last-child {
            border-bottom: none;
        }

        .label {
            font-weight: bold;
        }
    </style>
</head>

<body>

    <h1>Информация о заказе</h1>

    <div id="orderContainer">Загрузка...</div>

    <script>
      function renderField(label, name, value, editable) {
  if (!value && !editable) return '';

  return `
  <div class="row">
    <span class="label">${label}:</span>
    <span>
      ${editable
        ? `<input type="text" name="${name}" value="${value ?? ''}" data-original="${value ?? ''}" />`
        : value ?? '-'
      }
    </span>
  </div>`;
}

function renderTextarea(label, name, value, editable) {
  if (!value && !editable) return '';

  return `
  <div class="row">
    <span class="label">${label}:</span>
    <span>
      ${editable
        ? `<textarea name="${name}" data-original="${value ?? ''}">${value ?? ''}</textarea>`
        : value ?? '-'
      }
    </span>
  </div>`;
}

async function loadOrder() {
  const params = new URLSearchParams(window.location.search);
  const id = params.get("id");

  if (!id) {
    document.getElementById("orderContainer").innerHTML = "<p>Не передан ID заказа.</p>";
    return;
  }

  try {
    const response = await fetch(`/admin/full-order?id=${id}`);
    if (!response.ok) throw new Error("Ошибка получения данных");

    const data = await response.json();
    const { order, order_items } = data;

    const statusMap = {
      payment_failed: "Оплата не пройшла",
      processing: "В обработке",
      completed: "Завершено",
      paid: "Оплачено"
    };
    const humanStatus = statusMap[order.status] || order.status;

    const date = new Date(order.created_at);
    const formattedDate = date.toLocaleString("ru-RU", {
      day: "numeric",
      month: "long",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit"
    });

    // === ВАЖНО: проверка времени возврата ===
    const now = Date.now();
    const returningTime = Number(order.returning_time);
    const canCancel = now < returningTime;
    console.log(now < returningTime);
    
    const cancelButtonHtml = canCancel
      ? `<div class="card">
           <button id="cancelOrderBtn" style="
             background:#e74c3c;
             color:#fff;
             border:none;
             padding:12px 20px;
             border-radius:6px;
             cursor:pointer;
             font-size:16px;
             width:100%;
           ">
             Отменить заказ
           </button>
         </div>`
      : '';
         const editable = canCancel; // та же логика что и для отмены

const deliveryInfoHtml = `
<div class="card">
  <h2>Информация о доставке</h2>

  ${renderField("Имя", "full_name", order.full_name, editable)}
  ${renderField("Телефон", "phone_number", order.phone_number, editable)}
  ${renderField("Город", "city", order.city, editable)}
  ${renderField("Отделение", "department", order.department, editable)}
  ${renderField("Email", "email", order.email, editable)}
  ${renderTextarea("Комментарий", "comment", order.comment, editable)}

  ${editable ? `
    <button id="saveUserInfoBtn" disabled style="
      margin-top:15px;
      background:#2ecc71;
      color:#fff;
      border:none;
      padding:12px;
      border-radius:6px;
      cursor:pointer;
      font-size:16px;
      width:100%;
      opacity:0.6;
    ">
      Сохранить изменения
    </button>
  ` : ""}
</div>
`;

    document.getElementById("orderContainer").innerHTML = `
      <div class="card">
        <h2>Основная информация</h2>
        <div class="row"><span class="label">ID заказа:</span> <span>${order.order_id}</span></div>
        <div class="row"><span class="label">Статус:</span> <span>${humanStatus}</span></div>
        <div class="row"><span class="label">Создан:</span> <span>${formattedDate}</span></div>
        <div class="row"><span class="label">Скидка:</span> <span>${order.sale}</span></div>
        <div class="row"><span class="label">Общая цена:</span> <span>${order.total_price} грн</span></div>
      </div>

      ${deliveryInfoHtml}

      <div class="card">
      <h2>Товары в заказе</h2>
      ${data.order_items.map(item => `
        <div class="row"><span class="label">Название:</span> <span>${item.product_name}</span></div>
        <div class="row">
          <span class="label">Фото:</span>
          <span><img src="${item.product_img}" style="max-width:100px;border-radius:5px;"></span>
        </div>
        <div class="row"><span class="label">Количество:</span> <span>${item.quantity}</span></div>
        <div class="row"><span class="label">Цена:</span> <span>${item.price} грн</span></div>
        <hr>
      `).join('')}
    </div>


      ${cancelButtonHtml}
    `;
   if (canCancel) {
  const inputs = document.querySelectorAll('input[name], textarea[name]');
  const saveBtn = document.getElementById("saveUserInfoBtn");

  function checkChanges() {
    let changed = false;

    inputs.forEach(input => {
      if (input.value !== input.dataset.original) {
        changed = true;
      }
    });

    saveBtn.disabled = !changed;
    saveBtn.style.opacity = changed ? "1" : "0.6";
  }

  inputs.forEach(i => i.addEventListener("input", checkChanges));

  saveBtn.addEventListener("click", async () => {
    const userInfo = {};

    inputs.forEach(el => {
      if (el.value !== el.dataset.original) {
        userInfo[el.name] = el.value;
      }
    });

    try {
      const res = await fetch("/order/update/user-info", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          order_id: order.order_id,
          userInfo
        })
      });

      const result = await res.json();

      if (!res.ok) {
        alert(result.message || "Ошибка обновления данных");
        return;
      }

      alert("Данные успешно обновлены");
      location.reload();

    } catch (e) {
      console.error(e);
      alert("Ошибка соединения с сервером");
    }
  });
}


    if (canCancel) {
  document.getElementById("cancelOrderBtn").addEventListener("click", async () => {
    if (!confirm("Вы уверены, что хотите отменить заказ?")) return;

    try {
      const res = await fetch("/delete-order", {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          order_id: order.order_id
        })
      });

      const result = await res.json();

      if (!res.ok) {
        alert(result.message || "Ошибка при отмене заказа");
        return;
      }

      alert("Заказ был отменен успешно");
      window.location.href = "/getproducts"; // или куда нужно
    } catch (err) {
      console.error(err);
      alert("Ошибка соединения с сервером");
    }
  });
}


  } catch (err) {
    document.getElementById("orderContainer").innerHTML = "<p>Ошибка загрузки данных заказа.</p>";
    console.error(err);
  }
}

loadOrder();
</script>


</body>

</html>